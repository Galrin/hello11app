{% extends 'main/index.html' %}

{% block content %}
{#  <div class="container px-4 py-5" id="icon-grid">#}
{#    <h2 class="pb-2 border-bottom">Справочники</h2>#}
{##}
{#    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 py-5">#}
{##}
{##}
{#    </div>#}
{#  </div>#}



    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        .b-example-divider {
            width: 100%;
            height: 3rem;
            background-color: rgba(0, 0, 0, .1);
            border: solid rgba(0, 0, 0, .15);
            border-width: 1px 0;
            box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
        }

        .b-example-vr {
            flex-shrink: 0;
            width: 1.5rem;
            height: 100vh;
        }

        .bi {
            vertical-align: -.125em;
            fill: currentColor;
        }

        .nav-scroller {
            position: relative;
            z-index: 2;
            height: 2.75rem;
            overflow-y: hidden;
        }

        .nav-scroller .nav {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 1rem;
            margin-top: -1px;
            overflow-x: auto;
            text-align: center;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .btn-bd-primary {
            --bd-violet-bg: #712cf9;
            --bd-violet-rgb: 112.520718, 44.062154, 249.437846;

            --bs-btn-font-weight: 600;
            --bs-btn-color: var(--bs-white);
            --bs-btn-bg: var(--bd-violet-bg);
            --bs-btn-border-color: var(--bd-violet-bg);
            --bs-btn-hover-color: var(--bs-white);
            --bs-btn-hover-bg: #6528e0;
            --bs-btn-hover-border-color: #6528e0;
            --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
            --bs-btn-active-color: var(--bs-btn-hover-color);
            --bs-btn-active-bg: #5a23c8;
            --bs-btn-active-border-color: #5a23c8;
        }

        .bd-mode-toggle {
            z-index: 1500;
        }

        .bd-mode-toggle .dropdown-menu .active .bi {
            display: block !important;
        }
    </style>
    <div class="bd-example bd-example-flex">

        <div class="d-flex justify-content-between mb-3 border-bottom border-danger">
            <div class="p-2 bd-highlight"><h2 class="fw-bolde">Счета на оплату</h2></div>
            <div class="p-2 bd-highlight">
                <button type="button" class="btn btn-outline-danger pb-2" data-bs-toggle="modal"
                        data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-journal-plus" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                              d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5"></path>
                        <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2"></path>
                        <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z"></path>
                    </svg>
                    Добавить .csv
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Загрузить счета в формате
                        <span class="fw-bold" style="color:orange">.csv</span>&nbsp;
                         на сервер</h1>
                    <button type="button" class="btn-close btn-lg" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {#        <form>#}
                <div class="modal-body">

                    <div class="mb-3">
                        <input id="fileInput" type="file" class="form-control form-control-lg"
                               aria-label="Large file input example">
                    </div>
                    <div class="mb-3"><span id="status"></span></div>
                    <div class="mb-3">
                        <div class="progress mb-3" role="progressbar" aria-label="Example with label" aria-valuenow="0"
                             aria-valuemin="0" aria-valuemax="100">
                            <div id="progressBar" class="progress-bar bg-danger show" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="mb-3"><span id="status_load_in_tables"></span></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">Закрыть</button>
                    <button id="add_file" type="button" class="btn btn-success btn-lg"><!-- class="disabled" -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             class="bi bi-upload" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"></path>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"></path>
                        </svg>
                        Загрузить
                    </button>
                </div>
                {#        </form>#}
            </div>
        </div>
    </div>
    <div class="p-2 bd-highlight"><h5 class="fw-bold">Справочники</h5></div>



    <table id="table_item" class="table">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">Имя файла</th>
            <th scope="col">Дата загрузки</th>
            <th scope="col">количество строк</th>
        </tr>
        </thead>
        <tbody class="table-group-divider">

        {% if items %}
            {% for item in items %}
                <tr>
                    <th scope="row">{{ item.id }}</th>
                    <td>{{ item.file_name }}</td>
                    <td>{{ item.upload_date }}</td>
                    <td>{{ item.rows_count }}</td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <th scope="row">Данные отсутствуют</th>

            </tr>
        {% endif %}
        </tbody>
    </table>


    <script src="/static/js/jquery-3.7.1.min.js"></script>
    <script>
        let upload_handler_url = '/dashboard/upload';
        let intent_handler_url = '/main/api/intent/invoice';

        const button = document.getElementById('add_file');
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');
        const fileInput = document.getElementById('fileInput');
        const status_load_in_tables = document.getElementById('status_load_in_tables');

        function uploadFile() {

            status.innerText = "";
            progressBar.innerHTML = ""
            progressBar.style.width = "0%";

            var file = fileInput.files[0];

            const formData = new FormData();
            formData.append('file', file);

            //console.log(file)

            var xhr = new XMLHttpRequest();

            xhr.open('POST', upload_handler_url, true);
            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    var percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = "" + Math.round(percentComplete) + "%";
                    progressBar.innerHTML = "" + Math.round(percentComplete) + "%";
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    status.innerText = "Загрузка завершена";

                    intentAddInvoiceInSystem(file.name);
                } else {
                    console.log('Произошла ошибка при загрузке файла.');
                }
            };

            xhr.send(formData);
            {#   const fileInput = document.getElementById('fileInput');#}
            {#   const file = fileInput.files[0];#}
            {##}
            {#   if (file) {#}
            {#       const progressBar = document.getElementById('progressBar');#}
            {#       const status = document.getElementById('status');#}
            {##}
            {#       const formData = new FormData();#}
            {#       formData.append('file', file);#}
            {##}
            {#       fetch(upload_handler_url, {#}
            {#           method: 'POST',#}
            {#           body: formData#}
            {#       })#}
            {#       .then(response => {#}
            {#           if (!response.ok) {#}
            {#               throw new Error('Ошибка при загрузке файла');#}
            {#           }#}
            {#           const reader = response.body.getReader();#}
            {#           const contentLength = +response.headers.get('Content-Length');#}
            {#           let receivedLength = 0;#}
            {##}
            {#           return reader.read().then(function processResult({ done, value }) {#}
            {#               if (done) {#}
            {#                   status.innerText = "Загрузка завершена";#}
            {#                   return;#}
            {#               }#}
            {##}
            {#               receivedLength += value.length;#}
            {#               progressBar.style.width = "" + ((receivedLength / contentLength) * 100) + "%";#}
            {#               status.innerText = "Загружено " + Math.round(progressBar.innerHTML) + "%";#}
            {##}
            {#               // Continue reading#}
            {#               return reader.read().then(processResult);#}
            {#           });#}
            {#       })#}
            {#       .catch(error => {#}
            {#           console.error('Произошла ошибка:', error);#}
            {#       });#}
            {#   }#}
        }

        button.addEventListener('click', uploadFile);

        function intentAddInvoiceInSystem(file_name) {
            status_load_in_tables.innerText = "Обработка, подождите ...";
            var data = new FormData();
            data.append('file_name', file_name);

            var xhr = new XMLHttpRequest();
            xhr.open('GET', intent_handler_url + "/" + file_name, true);
            xhr.onload = function (ev) {
                // do something to response
                var res_text = this.responseText;
                var res_json = JSON.parse(this.responseText);
                console.log(res_text);
                if (xhr.status === 200) {
                    console.log("200 OK")

                    status_load_in_tables.innerText = "Успешно обработано " + res_json["rows_count"] + " строк";
                    //location.reload();
                    console.log($('#table_item').html())
                    var table_url = "{{ url_for('main_invoices.index') }}";
                    $("#table_item").load(table_url + ' #table_item', function () {
                        console.log("table reloaded");
                        //document.getElementById('table').innerHTML(this.innerHTML);
                    });

                }
                console.log(xhr.status)
            };
            xhr.send(data);
        }
    </script>

    <script>


    </script>

    <!--   <script src="/static/js/socket.io-3.0.4.min.js"></script> <script>
     function intentAddInvoiceInSystem(file_name) {
         const socket_route = '127.0.0.1' + intent_handler_url;

         const socket = io("ws://" + socket_route, {
             reconnectionDelayMax: 10000,
             auth: {
                 token: "123"
             },
             query: {
                 "file-name": file_name
             }
         });
         // Обработчик события приема новых данных от сервера
         socket.on('new_data', function (data) {
             // Обработка новых данных
             console.log("New data received:", data);
             // Здесь вы можете обновить интерфейс вашего приложения с полученными данными
         });
     }
     </script> -->
{% endblock %}